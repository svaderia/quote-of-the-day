#!/usr/bin/env python3

import json
import os
from datetime import datetime, timedelta
import random


# Helper function to get the next_day
def next_day(date):
    return date + timedelta(days=1)


# Helper function to get the previous_day
def prev_day(date):
    return date - timedelta(days=1)


def write_data(data):
    for mn in range(1, 13, 1):
        fname = f"quotes/{mn}.json"
        with open(fname, "w") as file:
            json.dump(data[mn], file, indent=4)


def main():
    # 1. Check if GITHUB_DIR env variable is set
    github_dir = os.getenv("GITHUB_DIR")
    if not github_dir:
        raise EnvironmentError("GITHUB_DIR environment variable is not set.")

    # 2. Change directory to GITHUB_DIR
    os.chdir(github_dir)

    # 3. Change directory to quote-of-the-day
    quote_dir = "quote-of-the-day"
    if not os.path.isdir(quote_dir):
        raise FileNotFoundError(f"The directory '{quote_dir}' does not exist.")
    os.chdir(quote_dir)

    # 4. Read quotes.json file
    quotes_file = "quotes.json"
    if not os.path.isfile(quotes_file):
        raise FileNotFoundError(f"The file '{quotes_file}' does not exist.")

    with open(quotes_file, "r", encoding="utf-8") as file:
        quotes_data = json.load(file)

    print("Total quotes: ", len(quotes_data))

    # Directory path
    directory_path = "quotes"

    # Create the directory if it doesn't exist
    if not os.path.exists(directory_path):
        os.makedirs(directory_path)
        print(f"Directory '{directory_path}' created.")
    else:
        print(f"Directory '{directory_path}' already exists.")

    # Get today's date and extract the month
    today = datetime.today()
    month = today.month

    # data to hold for the json
    data = {i + 1: {} for i in range(12)}

    random.seed(42)
    # init
    new_date = next_day(today)
    indices = [i for i in range(len(quotes_data))]
    random.shuffle(indices)
    i = 0

    # loop until you can't change anymore
    while new_date.day != today.day or new_date.month != today.month:
        mn = new_date.month
        dy = str(new_date.day)

        if dy in data[mn]:
            continue

        data[mn][dy] = indices[i]

        i += 1
        if i == len(quotes_data):
            random.shuffle(indices)
            i = 0

        new_date = next_day(new_date)

    mn = new_date.month
    dy = str(new_date.day)
    data[mn][dy] = indices[i]

    write_data(data)

    print("done")


if __name__ == "__main__":
    main()
